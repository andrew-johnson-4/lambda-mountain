
let preprocess-apply-locations(program: AST): AST = (
   match program {
      App{ left:Var{key:c"p"}, right:Lit{key:c":Location:",ltk=token} } => (
         let l = c"File: " + ltk.location.filename
               + c" Line: " + to-string(ltk.location.line)
               + c" Column: " + to-string(ltk.location.column);
         mk-lit(l, with-key(ltk.unique,l))
      );
      Lit{l=key,ltk=token} => mk-lit(l, ltk.unique);
      Var{l=key,ltk=token} => mk-var(l, ltk.unique);
      App{is-cons=is-cons,t0=left,t1=right} => mk-cons-or-app(is-cons, preprocess-apply-locations(t0), preprocess-apply-locations(t1));
      Seq{seq=seq} => (
         program = mk-eof();
         for p in seq { program = program + preprocess-apply-locations(p) };
         program
      );
      Abs{al=lhs, ar=rhs, tlt=tt} => mk-abs(preprocess-apply-locations(al), preprocess-apply-locations(ar), tlt);
      Glb{k=key, ar=val} => mk-glb(k.unique, preprocess-apply-locations(ar));
      _ => program;
   }
);

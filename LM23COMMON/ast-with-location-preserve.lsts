
let .with-location-preserve(term: AST, loc: SourceLocation): AST = (
   match term {
      Var{key=key,token=token} => Var(key,with-location(token,loc));
      Lit{key=key,token=token} => Lit(key,with-location(token,loc));
      App{is-cons=is-cons,left=left,right=right} => mk-cons-or-app(is-cons,left.with-location-preserve(loc),right.with-location-preserve(loc));
      Seq{seq=seq} => (
         let ret = mk-vector(type(AST), seq.length);
         for s in seq { ret = ret.push(s.with-location-preserve(loc)) };
         Seq(ret)
      );
      Abs{lhs=lhs,rhs=rhs,tt=tt} => Abs(close(lhs.with-location-preserve(loc)),close(rhs.with-location-preserve(loc)),tt);
      Glb{key=key,val=val} => Glb(with-location(key,loc),close(val.with-location-preserve(loc)));
      _ => term;
   }
);
